<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="description" content="Создай свой продукт-звезду за 2 минуты. Когнитивно-сенсорный мини-бриф по методике «Полярная звезда».">
<title>Генератор мясных продуктов — Звёзд</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles.css">
</head>
<body>
<main>
  <header class="ps-header">
    <img src="polar-star.png" alt="Логотип Polar Star" class="ps-logo" width="56" height="56">
    <div class="ps-headings">
      <h1 class="ps-title">Генератор мясных продуктов — Звёзд</h1>
      <p class="ps-subtitle">Создай свой продукт-звезду за 2 минуты ✦</p>
    </div>
  </header>

  <section class="card">
    <div class="row">
      <label class="field">
        <span class="field-label"><i data-lucide="layers"></i>Категория</span>
        <select id="category"></select>
        <input id="categoryCustom" type="text" placeholder="Свой вариант" style="margin-top:8px;display:none">
      </label>
      <label class="field">
        <span class="field-label"><i data-lucide="type"></i>Название</span>
        <span class="field-helper">Оставь пустым — Qwen предложит идеи</span>
        <input id="name" type="text" placeholder="Напр.: «Колбасёнок», «МОС-КУС»…">
      </label>
    </div>

    <div class="card inner-card">
      <h2 class="section-title"><i data-lucide="users"></i>Целевая аудитория</h2>
      <div class="row">
        <div class="field">
          <span class="field-label">Возраст</span>
          <div id="ages"></div>
        </div>
        <div class="field">
          <span class="field-label">Пол / группа</span>
          <div id="genders"></div>
        </div>
      </div>
    </div>

    <div class="row">
      <label class="field">
        <span class="field-label"><i data-lucide="alert-circle"></i>Потребительская боль</span>
        <span class="field-helper">Введи свою или выбери подсказку ниже</span>
        <textarea id="pain"></textarea>
        <div id="painHints" class="chips"></div>
      </label>
      <label class="field">
        <span class="field-label"><i data-lucide="star"></i>Уникальность / УТП</span>
        <span class="field-helper">Qwen допишет, если оставить пустым</span>
        <textarea id="uvp"></textarea>
      </label>
    </div>

    <label class="field" style="margin-top:12px">
      <span class="field-label"><i data-lucide="image"></i>Изображение упаковки</span>
      <span class="field-helper">PNG/JPG, до ~3 МБ</span>
      <input id="packImage" type="file" accept="image/*">
    </label>

    <div class="actions">
      <button id="gen" class="btn">
        <i data-lucide="sparkles"></i>
        Сгенерировать паспорт
      </button>
      <button id="docx" class="btn" disabled>
        <i data-lucide="download"></i>
        Скачать DOCX
      </button>
      <span id="gen-status">Готово</span>
      <span id="gen-error" class="error-text"></span>
    </div>
  </section>

  <section class="card">
    <h2 class="section-title"><i data-lucide="file-text"></i>Предпросмотр</h2>
    <div id="gen-out">Здесь появится черновик паспорта.</div>
  </section>
</main>

<script src="https://unpkg.com/lucide@latest"></script>
<script>
const $ = (sel) => document.querySelector(sel);
let BASE = null;
let packImageDataURL = null;
let PASSPORT = null;

const statusEl = $("#gen-status");
const errorEl = $("#gen-error");
const previewEl = $("#gen-out");
const genBtn = $("#gen");
const docxBtn = $("#docx");

async function loadBase() {
  const res = await fetch("/base.json");
  BASE = await res.json();
  const select = $("#category");
  BASE.meatCategories.forEach((item) => {
    const option = document.createElement("option");
    option.value = item;
    option.textContent = item;
    select.appendChild(option);
  });
  select.addEventListener("change", () => {
    $("#categoryCustom").style.display = select.value === "Свой вариант" ? "block" : "none";
    renderPainHints();
  });
  renderAudience();
  renderPainHints();
}

function renderAudience() {
  const agesEl = $("#ages");
  const gendersEl = $("#genders");
  agesEl.innerHTML = "";
  gendersEl.innerHTML = "";
  BASE.ageBuckets.forEach((age) => {
    const wrap = document.createElement("label");
    wrap.className = "chip";
    wrap.innerHTML = `<input type="checkbox" value="${age}"> ${age}`;
    agesEl.appendChild(wrap);
  });
  BASE.genders.forEach((g) => {
    const wrap = document.createElement("label");
    wrap.className = "chip";
    wrap.style.display = "inline-flex";
    wrap.innerHTML = `<input type="checkbox" value="${g}"> ${g}`;
    gendersEl.appendChild(wrap);
  });
}

function renderPainHints() {
  const category = $("#category").value;
  const hints = BASE.painsByCategory[category] || BASE.painsByCategory.default;
  const box = $("#painHints");
  box.innerHTML = "";
  hints.forEach((hint) => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "chip";
    btn.textContent = hint;
    btn.addEventListener("click", () => {
      $("#pain").value = hint;
    });
    box.appendChild(btn);
  });
}

$("#packImage").addEventListener("change", (event) => {
  const file = event.target.files?.[0];
  if (!file) {
    packImageDataURL = null;
    return;
  }
  const reader = new FileReader();
  reader.onload = () => {
    packImageDataURL = reader.result;
  };
  reader.readAsDataURL(file);
});

function setStatus(message, variant) {
  statusEl.textContent = message || "";
  statusEl.classList.remove("ok", "err");
  if (!message) return;
  if (variant === "ok") statusEl.classList.add("ok");
  if (variant === "err") statusEl.classList.add("err");
}

function setError(message) {
  errorEl.textContent = message || "";
}

function collectPayload() {
  const select = $("#category");
  let category = select.value;
  if (category === "Свой вариант") {
    category = $("#categoryCustom").value.trim();
  }
  category = (category || "").trim();
  if (!category) {
    throw new Error("Укажи категорию продукта");
  }
  const name = $("#name").value.trim();
  const pain = $("#pain").value.trim();
  const uvp = $("#uvp").value.trim();
  const ages = [...document.querySelectorAll("#ages input:checked")].map((el) => el.value);
  const genders = [...document.querySelectorAll("#genders input:checked")].map((el) => el.value);
  return {
    category,
    name: name || null,
    audience: [...ages, ...genders],
    pains: pain ? [pain] : [],
    uniqueness: uvp || null,
    imageDataUrl: packImageDataURL || null
  };
}

function renderDraft(draft) {
  if (!draft) {
    previewEl.textContent = "Черновик пуст.";
    return;
  }
  if (typeof draft === "string") {
    previewEl.textContent = draft;
    return;
  }
  previewEl.textContent = JSON.stringify(draft, null, 2);
}

async function onGenerate() {
  setError("");
  setStatus("Генерируем…");
  genBtn.disabled = true;
  docxBtn.disabled = true;

  let payload;
  try {
    payload = collectPayload();
  } catch (err) {
    setError(err.message);
    setStatus("");
    genBtn.disabled = false;
    return;
  }

  try {
    const res = await fetch("/api/generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      throw new Error(data?.error || `HTTP ${res.status}`);
    }
    PASSPORT = { draft: data.draft, mode: data.mode };
    renderDraft(data.draft);
    setStatus(data.mode === "llm" ? "Готово (LLM)" : "Готово (локально)", "ok");
    docxBtn.disabled = false;
  } catch (err) {
    setError(err.message || "Сбой генерации");
    setStatus("", "err");
  } finally {
    genBtn.disabled = false;
  }
}

async function onDownloadDocx() {
  if (!PASSPORT || !PASSPORT.draft) {
    alert("Сначала сгенерируй паспорт.");
    return;
  }
  setError("");
  setStatus("Сборка DOCX…");
  try {
    const res = await fetch("/api/generate-docx", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ answers: PASSPORT.draft, packImageDataURL })
    });
    if (!res.ok) {
      const text = await res.text().catch(() => "");
      throw new Error(text || "DOCX не собран");
    }
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    const suggestedName = typeof PASSPORT.draft === "object" && PASSPORT.draft
      ? (PASSPORT.draft.title || PASSPORT.draft.category || "passport")
      : "passport";
    a.href = url;
    a.download = `${suggestedName}.docx`;
    a.click();
    URL.revokeObjectURL(url);
    setStatus("DOCX готов", "ok");
  } catch (err) {
    setError(err.message || "Не удалось собрать DOCX.");
    setStatus("Не удалось собрать DOCX", "err");
  }
}

genBtn.addEventListener("click", onGenerate);
docxBtn.addEventListener("click", onDownloadDocx);
loadBase();
lucide.createIcons();
</script>
</body>
</html>
